# Модуль импорта клиентов

Модуль для автоматической загрузки клиентской базы из Excel файлов (XLSX, XLS, CSV).

## Возможности

- ✅ Парсинг Excel файлов (XLSX, XLS, CSV)
- ✅ Автоматический разбор ФИО на компоненты (фамилия, имя, отчество)
- ✅ Обработка множественных телефонов (через запятую/пробел)
- ✅ Валидация и нормализация телефонных номеров
- ✅ Автоматическое создание регионов (только ROOT)
- ✅ Умная дедупликация при обновлении базы
- ✅ Детальное логирование ошибок
- ✅ Оптимизация для больших файлов (до 10к строк)

## API Endpoint

### POST `/api/import/clients?groupId={uuid}`

Импортирует клиентов из загруженного файла в указанную группу.

**Параметры:**
- `groupId` (query, обязательный) - UUID группы клиентов
- `file` (form-data, обязательный) - Excel файл (XLSX, XLS, CSV)

**Требования к файлу:**
- Формат: `.xlsx`, `.xls`, `.csv`
- Максимальный размер: 50MB
- Обязательные колонки:
  - `name` (или: имя, фио, full name, полное имя, контакт) - Полное ФИО
  - `phone` (или: телефон, tel, mobile, мобильный, номер) - Номера телефонов
  - `region` (или: регион, область, город, city, area) - Название региона

**Ответ:**
```json
{
  "success": true,
  "statistics": {
    "total": 100,
    "created": 80,
    "updated": 15,
    "skipped": 5,
    "errors": 0,
    "regionsCreated": 3
  },
  "message": "Import completed successfully",
  "groupId": "uuid",
  "groupName": "Название группы"
}
```

## Логика работы

### Парсинг ФИО
- Формат: "Фамилия Имя Отчество" (3 слова)
- 4-е слово типа "Оглы" игнорируется
- Если ФИО отсутствует - клиент создается с дефолтными значениями

### Парсинг телефонов
- Поддержка множественных номеров (через запятую/пробел)
- Нормализация форматов: `+7`, `8`, `7` → `+79991234567`
- Валидация через `libphonenumber-js`
- Сохранение только валидных номеров

### Обработка регионов
- Поиск существующего региона (case-insensitive)
- Если не найден и пользователь ROOT - создание нового
- Если не найден и пользователь не ROOT - клиент создается без региона

### Дедупликация
1. **Новый контакт** (новый номер) → создается новый клиент
2. **Найден по номеру, нет ФИО в старом** → обновляется, добавляется ФИО
3. **Найден по номеру, появился новый номер** → добавляется новый номер
4. **Полное совпадение** → пропускается (не дублируется)

## Владение клиентами

**Важно:** Клиенты принадлежат **владельцу группы**, а не пользователю, который выполняет импорт.

Пример:
- Пользователь A создал группу "Группа A"
- Пользователь B (или ROOT) импортирует клиентов в "Группа A"
- Клиенты будут принадлежать пользователю A (владельцу группы)

## Безопасность

- Все endpoints требуют авторизации
- Проверка существования группы перед импортом
- Проверка прав доступа к группе
- Валидация формата и размера файла
- Детальное логирование всех операций

## Производительность

- Кэширование регионов в памяти
- Транзакции для атомарности операций
- Обработка до 10,000 строк
- Логирование прогресса для больших файлов

