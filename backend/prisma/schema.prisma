// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================
// Enums
// ============================================

/// Роли пользователей в системе
/// ROOT - администратор системы (создается из env, имеет полный доступ)
/// USER - обычный пользователь (создается только root'ом)
enum UserRole {
  ROOT
  USER
}

/// Статус клиента
/// NEW - новый клиент
/// OLD - старый клиент
enum ClientStatus {
  NEW
  OLD
}

/// Статус мессенджера для телефона
/// Valid - номер валиден в мессенджере
/// Invalid - номер невалиден в мессенджере
/// Unknown - статус неизвестен (по умолчанию)
enum MessengerStatus {
  Valid
  Invalid
  Unknown
}

/// Статус профиля Chrome
/// STOPPED - профиль остановлен
/// RUNNING - профиль запущен и работает
/// STARTING - профиль запускается
/// STOPPING - профиль останавливается
/// ERROR - ошибка при работе профиля
enum ProfileStatus {
  STOPPED
  RUNNING
  STARTING
  STOPPING
  ERROR
}

// ============================================
// Models
// ============================================

/// Пользователь системы
/// 
/// Безопасность:
/// - passwordHash: всегда хранится хеш пароля (bcrypt), никогда plaintext
/// - email: уникальный индекс для предотвращения дубликатов
/// - role: индекс для быстрого поиска по роли
/// - isActive: позволяет деактивировать пользователя без удаления
/// - passwordVersion: позволяет инвалидировать все токены при смене пароля
model User {
  id             String    @id @default(uuid()) // UUID для безопасности (не предсказуемый)
  email          String    @unique // Уникальный email (индекс создается автоматически)
  passwordHash   String    // Хешированный пароль (bcrypt), НИКОГДА не plaintext!
  role           UserRole  @default(USER) // Роль пользователя (ROOT или USER)
  name           String?   // Опциональное имя пользователя
  isActive       Boolean   @default(true) // Активен ли пользователь (может быть деактивирован root'ом)
  passwordVersion Int      @default(1) // Версия пароля (для инвалидации токенов при смене пароля)
  createdAt      DateTime  @default(now()) // Время создания
  updatedAt      DateTime  @updatedAt // Время последнего обновления

  // Связь с refresh токенами (каскадное удаление)
  refreshTokens  RefreshToken[]
  
  // Связи с клиентами и группами клиентов
  clientGroups   ClientGroup[]
  clients        Client[]
  importConfigs  ImportConfig[] // Конфигурации импорта
  profiles       Profile[] // Профили Chrome
  profileLimits  UserProfileLimits? // Лимиты профилей (один-к-одному)

  // Индексы для оптимизации запросов
  @@index([email]) // Быстрый поиск по email (уже есть @unique, но явный индекс для ясности)
  @@index([role]) // Быстрый поиск по роли (например, проверка наличия ROOT пользователя)
  @@index([isActive]) // Быстрый поиск активных пользователей
  @@map("users") // Явное имя таблицы в БД
}

/// Refresh токен для обновления access токенов
/// 
/// Безопасность:
/// - token: уникальный JWT refresh token
/// - expiresAt: время истечения для автоматической очистки
/// - userId: связь с пользователем (каскадное удаление при удалении пользователя)
model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique // JWT refresh token (уникальный для предотвращения дубликатов)
  userId    String   // ID пользователя
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime // Время истечения токена
  createdAt DateTime @default(now())

  // Индексы для оптимизации запросов
  @@index([userId]) // Быстрый поиск токенов пользователя
  @@index([expiresAt]) // Быстрая очистка истекших токенов (запросы по времени)
  @@index([token]) // Быстрая проверка существования токена (уже есть @unique, но явный индекс)
  @@map("refresh_tokens") // Явное имя таблицы в БД
}

/// Справочник регионов
/// Статический справочник, общий для всех пользователей
model Region {
  id        String   @id @default(uuid())
  name      String   @unique // Название региона (уникальное)
  createdAt DateTime @default(now())
  
  // Связь с клиентами
  clients   Client[]
  
  @@index([name]) // Быстрый поиск по названию
  @@map("regions")
}

/// Группы клиентов конкретного пользователя
/// Каждый пользователь может создавать свои группы для организации клиентов
model ClientGroup {
  id          String    @id @default(uuid())
  userId      String    // ID пользователя-владельца
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  name        String    // Название группы
  description String?   // Описание (опционально)
  color       String?   // HEX цвет или название цвета (опционально)
  orderIndex  Int?      // Порядок сортировки (опционально)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // Связь с клиентами
  clients     Client[]
  
  // Индексы для оптимизации запросов
  @@index([userId]) // Быстрый поиск групп пользователя
  @@index([userId, name]) // Уникальность названия группы для пользователя
  @@map("client_groups")
}

/// Карточка клиента
/// Основная информация о клиенте, принадлежащая конкретному пользователю
model Client {
  id         String       @id @default(uuid())
  userId     String       // ID пользователя-владельца
  user       User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  lastName   String       // Фамилия
  firstName  String       // Имя
  middleName String?      // Отчество (опционально)
  regionId   String?      // ID региона (опционально)
  region     Region?      @relation(fields: [regionId], references: [id], onDelete: SetNull)
  groupId    String       // ID группы клиентов (обязательно)
  group      ClientGroup  @relation(fields: [groupId], references: [id], onDelete: Cascade)
  status     ClientStatus @default(NEW) // Статус клиента (NEW или OLD)
  createdAt  DateTime     @default(now())
  
  // Связь с телефонами клиента
  phones     ClientPhone[]
  
  // Индексы для оптимизации запросов
  @@index([userId]) // Быстрый поиск клиентов пользователя
  @@index([regionId]) // Быстрый поиск по региону
  @@index([groupId]) // Быстрый поиск по группе
  @@index([status]) // Быстрый поиск по статусу
  @@index([userId, status]) // Комбинированный поиск клиентов пользователя по статусу
  @@map("clients")
}

/// Телефоны клиента
/// Один клиент может иметь несколько телефонов (связь один-ко-многим)
model ClientPhone {
  id             String          @id @default(uuid())
  clientId      String          // ID клиента
  client         Client          @relation(fields: [clientId], references: [id], onDelete: Cascade)
  phone          String          // Номер телефона
  whatsAppStatus MessengerStatus @default(Unknown) // Статус WhatsApp (Valid, Invalid, Unknown)
  telegramStatus MessengerStatus @default(Unknown) // Статус Telegram (Valid, Invalid, Unknown)
  
  // Индексы для оптимизации запросов
  @@index([clientId]) // Быстрый поиск телефонов клиента
  @@map("client_phones")
}

/// Конфигурации импорта клиентов
/// Каждый пользователь может создавать свои конфигурации для настройки процесса импорта
model ImportConfig {
  id          String   @id @default(uuid())
  userId      String   // ID пользователя-владельца
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name        String   // Название конфигурации
  description String?  // Описание (опционально)
  isDefault   Boolean  @default(false) // Конфигурация по умолчанию
  
  // Конфигурация хранится как JSON
  // Структура: ImportConfig из types/import-config.types.ts
  config      String   // JSON строка с конфигурацией
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Индексы для оптимизации запросов
  @@index([userId]) // Быстрый поиск конфигураций пользователя
  @@index([userId, isDefault]) // Поиск конфигурации по умолчанию
  @@index([userId, name]) // Уникальность названия конфигурации для пользователя
  @@map("import_configs")
}

/// Профиль Chrome браузера
/// Каждый пользователь может создавать свои профили для работы с мессенджерами
model Profile {
  id          String        @id @default(uuid()) // UUID для безопасности
  userId      String        // ID пользователя-владельца
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name        String        // Название профиля
  description String?       // Описание профиля (опционально)
  
  // Путь к директории профиля Chrome (уникальный)
  profilePath String        @unique
  
  // Статус профиля
  status      ProfileStatus @default(STOPPED)
  
  // Режим работы: headless (без UI) или с UI
  headless    Boolean       @default(true) // По умолчанию без UI
  
  // Метаданные
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  lastActiveAt DateTime?     // Последняя активность профиля
  
  // Индексы для оптимизации запросов
  @@index([userId]) // Быстрый поиск профилей пользователя
  @@index([status]) // Быстрый поиск по статусу
  @@index([userId, status]) // Комбинированный поиск профилей пользователя по статусу
  @@map("profiles")
}

/// Лимиты профилей для пользователей
/// Настраиваются ROOT пользователем для каждого пользователя
model UserProfileLimits {
  id          String   @id @default(uuid()) // UUID для безопасности
  userId      String   @unique // ID пользователя (один-к-одному)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Лимит количества профилей
  maxProfiles Int      @default(10) // Максимальное количество профилей (по умолчанию 10)
  
  // Лимиты ресурсов на профиль (опционально, для будущего использования)
  maxCpuPerProfile      Float?   // Максимальное использование CPU на профиль (0-1)
  maxMemoryPerProfile   Int?     // Максимальное использование памяти на профиль (MB)
  maxNetworkPerProfile  Int?     // Максимальная скорость сети на профиль (KB/s, опционально)
  
  // Метаданные
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  updatedBy   String?  // ID пользователя, который обновил лимиты (обычно ROOT)
  
  @@map("user_profile_limits")
}

