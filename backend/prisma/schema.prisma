// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================
// Enums
// ============================================

/// Роли пользователей в системе
/// ROOT - администратор системы (создается из env, имеет полный доступ)
/// USER - обычный пользователь (создается только root'ом)
enum UserRole {
  ROOT
  USER
}

// ============================================
// Models
// ============================================

/// Пользователь системы
/// 
/// Безопасность:
/// - passwordHash: всегда хранится хеш пароля (bcrypt), никогда plaintext
/// - email: уникальный индекс для предотвращения дубликатов
/// - role: индекс для быстрого поиска по роли
/// - isActive: позволяет деактивировать пользователя без удаления
/// - passwordVersion: позволяет инвалидировать все токены при смене пароля
model User {
  id             String    @id @default(uuid()) // UUID для безопасности (не предсказуемый)
  email          String    @unique // Уникальный email (индекс создается автоматически)
  passwordHash   String    // Хешированный пароль (bcrypt), НИКОГДА не plaintext!
  role           UserRole  @default(USER) // Роль пользователя (ROOT или USER)
  name           String?   // Опциональное имя пользователя
  isActive       Boolean   @default(true) // Активен ли пользователь (может быть деактивирован root'ом)
  passwordVersion Int      @default(1) // Версия пароля (для инвалидации токенов при смене пароля)
  createdAt      DateTime  @default(now()) // Время создания
  updatedAt      DateTime  @updatedAt // Время последнего обновления

  // Связь с refresh токенами (каскадное удаление)
  refreshTokens  RefreshToken[]

  // Индексы для оптимизации запросов
  @@index([email]) // Быстрый поиск по email (уже есть @unique, но явный индекс для ясности)
  @@index([role]) // Быстрый поиск по роли (например, проверка наличия ROOT пользователя)
  @@index([isActive]) // Быстрый поиск активных пользователей
  @@map("users") // Явное имя таблицы в БД
}

/// Refresh токен для обновления access токенов
/// 
/// Безопасность:
/// - token: уникальный JWT refresh token
/// - expiresAt: время истечения для автоматической очистки
/// - userId: связь с пользователем (каскадное удаление при удалении пользователя)
model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique // JWT refresh token (уникальный для предотвращения дубликатов)
  userId    String   // ID пользователя
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime // Время истечения токена
  createdAt DateTime @default(now())

  // Индексы для оптимизации запросов
  @@index([userId]) // Быстрый поиск токенов пользователя
  @@index([expiresAt]) // Быстрая очистка истекших токенов (запросы по времени)
  @@index([token]) // Быстрая проверка существования токена (уже есть @unique, но явный индекс)
  @@map("refresh_tokens") // Явное имя таблицы в БД
}

