FROM node:20-alpine

RUN apk add --no-cache openssl libc6-compat

WORKDIR /app

COPY package*.json ./
COPY .env.example ./
RUN npm install

COPY . .

ENV PRISMA_ENGINES_CHECKSUM_IGNORE_MISSING=1
ENV PRISMA_SKIP_POSTINSTALL_GENERATE=1
ENV PRISMA_ENGINES_MIRROR=https://binaries.prisma.sh
RUN apk add --no-cache curl && \
    for i in 1 2 3 4 5 6 7 8 9 10; do \
      echo "Attempt $i to generate Prisma client..." && \
      npx prisma generate && break || \
      (echo "Failed, waiting 30 seconds before retry..." && sleep 30); \
    done

RUN mkdir -p logs

EXPOSE 3000

CMD ["npm", "run", "dev"]

