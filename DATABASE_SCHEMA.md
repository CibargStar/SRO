# Схема базы данных

Документация структуры базы данных проекта SRO.

## Общая информация

- **База данных**: SQLite
- **ORM**: Prisma
- **Все ID**: UUID (String)

## Диаграмма связей

```
User (Пользователь)
├── RefreshToken[] (Токены обновления)
├── ClientGroup[] (Группы клиентов)
└── Client[] (Клиенты)

Region (Регион)
└── Client[] (Клиенты)

ClientGroup (Группа клиентов)
├── User (Владелец)
└── Client[] (Клиенты)

Client (Клиент)
├── User (Владелец)
├── Region? (Регион, опционально)
├── ClientGroup? (Группа, опционально)
└── ClientPhone[] (Телефоны)

ClientPhone (Телефон клиента)
└── Client (Клиент)
```

## Модели данных

### User (Пользователь)

Основная модель пользователя системы.

| Поле | Тип | Описание | Ограничения |
|------|-----|----------|-------------|
| `id` | String (UUID) | Уникальный идентификатор | Primary Key |
| `email` | String | Email пользователя | Unique, Indexed |
| `passwordHash` | String | Хешированный пароль (bcrypt) | Required |
| `role` | UserRole | Роль пользователя | Enum: ROOT, USER (default: USER) |
| `name` | String? | Имя пользователя | Optional |
| `isActive` | Boolean | Активен ли пользователь | Default: true, Indexed |
| `passwordVersion` | Int | Версия пароля | Default: 1 |
| `createdAt` | DateTime | Время создания | Auto |
| `updatedAt` | DateTime | Время обновления | Auto |

**Связи:**
- `refreshTokens`: RefreshToken[] (один-ко-многим, каскадное удаление)
- `clientGroups`: ClientGroup[] (один-ко-многим, каскадное удаление)
- `clients`: Client[] (один-ко-многим, каскадное удаление)

**Индексы:**
- `email` (unique)
- `role`
- `isActive`

**Безопасность:**
- Пароль всегда хранится в хешированном виде (bcrypt)
- `passwordVersion` позволяет инвалидировать все токены при смене пароля
- `isActive` позволяет деактивировать пользователя без удаления

---

### RefreshToken (Токен обновления)

Токены для обновления access токенов.

| Поле | Тип | Описание | Ограничения |
|------|-----|----------|-------------|
| `id` | String (UUID) | Уникальный идентификатор | Primary Key |
| `token` | String | JWT refresh token | Unique, Indexed |
| `userId` | String (UUID) | ID пользователя | Foreign Key → User.id |
| `expiresAt` | DateTime | Время истечения токена | Required, Indexed |
| `createdAt` | DateTime | Время создания | Auto |

**Связи:**
- `user`: User (многие-к-одному, каскадное удаление)

**Индексы:**
- `userId`
- `expiresAt`
- `token` (unique)

**Поведение при удалении:**
- При удалении пользователя все его токены удаляются автоматически (Cascade)

---

### Region (Регион)

Справочник регионов. Общий для всех пользователей.

| Поле | Тип | Описание | Ограничения |
|------|-----|----------|-------------|
| `id` | String (UUID) | Уникальный идентификатор | Primary Key |
| `name` | String | Название региона | Unique, Indexed |
| `createdAt` | DateTime | Время создания | Auto |

**Связи:**
- `clients`: Client[] (один-ко-многим, SetNull при удалении)

**Индексы:**
- `name` (unique)

**Права доступа:**
- Создание/редактирование/удаление: только ROOT
- Просмотр: все авторизованные пользователи

**Поведение при удалении:**
- При удалении региона у клиентов `regionId` устанавливается в `null` (SetNull)

---

### ClientGroup (Группа клиентов)

Группы для организации клиентов. Принадлежат конкретному пользователю.

| Поле | Тип | Описание | Ограничения |
|------|-----|----------|-------------|
| `id` | String (UUID) | Уникальный идентификатор | Primary Key |
| `userId` | String (UUID) | ID пользователя-владельца | Foreign Key → User.id, Indexed |
| `name` | String | Название группы | Required |
| `description` | String? | Описание группы | Optional |
| `color` | String? | HEX цвет или название цвета | Optional |
| `orderIndex` | Int? | Порядок сортировки | Optional |
| `createdAt` | DateTime | Время создания | Auto |
| `updatedAt` | DateTime | Время обновления | Auto |

**Связи:**
- `user`: User (многие-к-одному, каскадное удаление)
- `clients`: Client[] (один-ко-многим, SetNull при удалении)

**Индексы:**
- `userId`
- `userId + name` (уникальность названия группы для пользователя)

**Права доступа:**
- Каждый пользователь видит и управляет только своими группами

**Поведение при удалении:**
- При удалении пользователя все его группы удаляются автоматически (Cascade)
- При удалении группы у клиентов `groupId` устанавливается в `null` (SetNull)

---

### Client (Клиент)

Основная информация о клиенте. Принадлежит конкретному пользователю.

| Поле | Тип | Описание | Ограничения |
|------|-----|----------|-------------|
| `id` | String (UUID) | Уникальный идентификатор | Primary Key |
| `userId` | String (UUID) | ID пользователя-владельца | Foreign Key → User.id, Indexed |
| `lastName` | String | Фамилия | Required, Max 100 chars |
| `firstName` | String | Имя | Required, Max 100 chars |
| `middleName` | String? | Отчество | Optional, Max 100 chars |
| `regionId` | String? (UUID) | ID региона | Foreign Key → Region.id, Optional, Indexed |
| `groupId` | String? (UUID) | ID группы клиентов | Foreign Key → ClientGroup.id, Optional, Indexed |
| `status` | ClientStatus | Статус клиента | Enum: NEW, OLD (default: NEW), Indexed |
| `createdAt` | DateTime | Время создания | Auto |

**Связи:**
- `user`: User (многие-к-одному, каскадное удаление)
- `region`: Region? (многие-к-одному, SetNull при удалении)
- `group`: ClientGroup? (многие-к-одному, SetNull при удалении)
- `phones`: ClientPhone[] (один-ко-многим, каскадное удаление)

**Индексы:**
- `userId`
- `regionId`
- `groupId`
- `status`
- `userId + status` (комбинированный индекс)

**Права доступа:**
- Каждый пользователь видит и управляет только своими клиентами

**Поведение при удалении:**
- При удалении пользователя все его клиенты удаляются автоматически (Cascade)
- При удалении региона у клиента `regionId` устанавливается в `null` (SetNull)
- При удалении группы у клиента `groupId` устанавливается в `null` (SetNull)
- При удалении клиента все его телефоны удаляются автоматически (Cascade)

---

### ClientPhone (Телефон клиента)

Телефоны клиента. Один клиент может иметь несколько телефонов.

| Поле | Тип | Описание | Ограничения |
|------|-----|----------|-------------|
| `id` | String (UUID) | Уникальный идентификатор | Primary Key |
| `clientId` | String (UUID) | ID клиента | Foreign Key → Client.id, Indexed |
| `phone` | String | Номер телефона | Required, Max 20 chars |

**Связи:**
- `client`: Client (многие-к-одному, каскадное удаление)

**Индексы:**
- `clientId`

**Валидация:**
- Формат номера телефона валидируется через Zod схему
- Поддерживаются различные форматы: +7 (999) 123-45-67, 8 (999) 123-45-67, +79991234567, и т.д.

**Поведение при удалении:**
- При удалении клиента все его телефоны удаляются автоматически (Cascade)

---

## Enums (Перечисления)

### UserRole

Роли пользователей в системе.

- `ROOT` - Администратор системы (создается из env, имеет полный доступ)
- `USER` - Обычный пользователь (создается только ROOT'ом)

### ClientStatus

Статус клиента.

- `NEW` - Новый клиент (по умолчанию)
- `OLD` - Старый клиент

---

## Правила доступа

### Пользователи (User)

- **ROOT**: Полный доступ ко всем функциям, включая управление пользователями и регионами
- **USER**: Доступ только к своим клиентам и группам клиентов

### Клиенты (Client)

- Каждый пользователь видит и управляет только своими клиентами
- Фильтрация по `userId` происходит автоматически на уровне контроллера

### Группы клиентов (ClientGroup)

- Каждый пользователь видит и управляет только своими группами
- Уникальность названия группы проверяется в комбинации с `userId`

### Регионы (Region)

- **Создание/редактирование/удаление**: Только ROOT
- **Просмотр**: Все авторизованные пользователи
- Регионы являются справочником, общим для всех пользователей

### Телефоны клиентов (ClientPhone)

- Доступ к телефонам контролируется через принадлежность клиента пользователю
- Если пользователь имеет доступ к клиенту, он может управлять его телефонами

---

## Стратегии удаления (Cascade vs SetNull)

### Cascade (Каскадное удаление)

При удалении родительской записи дочерние записи удаляются автоматически:

- `User` → `RefreshToken` (удаляются все токены)
- `User` → `ClientGroup` (удаляются все группы)
- `User` → `Client` (удаляются все клиенты)
- `Client` → `ClientPhone` (удаляются все телефоны)

### SetNull (Установка NULL)

При удалении родительской записи внешний ключ в дочерней записи устанавливается в `null`:

- `Region` → `Client.regionId` (регион клиента становится `null`)
- `ClientGroup` → `Client.groupId` (группа клиента становится `null`)

---

## Индексы и оптимизация

### Основные индексы

1. **User**:
   - `email` (unique) - быстрый поиск по email
   - `role` - фильтрация по роли
   - `isActive` - поиск активных пользователей

2. **RefreshToken**:
   - `userId` - поиск токенов пользователя
   - `expiresAt` - очистка истекших токенов
   - `token` (unique) - проверка существования токена

3. **Region**:
   - `name` (unique) - быстрый поиск по названию

4. **ClientGroup**:
   - `userId` - поиск групп пользователя
   - `userId + name` (composite) - уникальность названия для пользователя

5. **Client**:
   - `userId` - поиск клиентов пользователя
   - `regionId` - фильтрация по региону
   - `groupId` - фильтрация по группе
   - `status` - фильтрация по статусу
   - `userId + status` (composite) - комбинированный поиск

6. **ClientPhone**:
   - `clientId` - поиск телефонов клиента

---

## Миграции

Все изменения схемы базы данных должны выполняться через Prisma Migrations:

```bash
# Создание новой миграции
npx prisma migrate dev --name migration_name

# Применение миграций в production
npx prisma migrate deploy

# Генерация Prisma Client после изменений
npx prisma generate
```

---

## Безопасность

### Хранение паролей

- Пароли **никогда** не хранятся в plaintext
- Используется bcrypt для хеширования
- `passwordVersion` позволяет инвалидировать все токены при смене пароля

### UUID вместо автоинкремента

- Все ID используют UUID для предотвращения предсказуемости
- UUID генерируются автоматически при создании записи

### Валидация данных

- Валидация на уровне Prisma схемы
- Дополнительная валидация через Zod на уровне API
- Проверка прав доступа на уровне контроллеров

---

## Примеры запросов

### Получение всех клиентов пользователя с телефонами

```typescript
const clients = await prisma.client.findMany({
  where: { userId },
  include: {
    region: { select: { id: true, name: true } },
    group: { select: { id: true, name: true, color: true } },
    phones: { select: { id: true, phone: true } },
  },
});
```

### Получение клиентов с фильтрацией и пагинацией

```typescript
const clients = await prisma.client.findMany({
  where: {
    userId,
    status: 'NEW',
    regionId: regionId,
  },
  skip: (page - 1) * limit,
  take: limit,
  orderBy: { createdAt: 'desc' },
});
```

### Проверка принадлежности клиента пользователю

```typescript
const client = await prisma.client.findUnique({
  where: { id: clientId },
  select: { userId: true },
});

if (client?.userId !== userId) {
  // Доступ запрещен
}
```

---

## Версия

**Дата создания**: 2025-11-20  
**Версия схемы**: 1.0.0  
**Последнее обновление**: 2025-11-20

